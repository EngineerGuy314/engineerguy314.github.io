<html>
    <head>
        <title>Query WSPR Live</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-07H1M3KB40"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-07H1M3KB40');
</script>

        <script src="./js/sorttable.js"></script>
        <script type='module'>
import * as utl from './js/Utl.js';
import { QuerierWsprLive } from './js/QuerierWsprLive.js';
import { WSPREncoded } from './js/WSPREncoded.js';


export class App
{
    constructor()
    {
        this.querier = new QuerierWsprLive();

        this.domInput = document.getElementById("input");
        this.domQuery = document.getElementById("query");
        this.domResult = document.getElementById("result");
        this.domInput2 = document.getElementById("input2");
        this.domQuery2 = document.getElementById("query2");
        this.domResult2 = document.getElementById("result2");

        // override the query default if one exists in the url
        this.OnUrlChange();

        window.addEventListener("popstate", (event) => {
            this.OnUrlChange();
        });

        this.domQuery.onclick = e => {
            this.DoQuery();
        };

        this.domQuery2.onclick = this.domQuery.onclick;
    }

    OnUrlChange()
    {
        utl.SetDomValBySearchParam(this.domInput, "query");
        utl.SetDomValBySearchParam(this.domInput2, "query2");

        this.DoQuery();
    }
    
    DoQuery()
    {
        WSPREncoded.EnableDebug();

        // update the url with the query so it can be bookmarked or just refereshed
        let query = this.domInput.value;
        let query2 = this.domInput2.value;
        
        let queryEncoded = encodeURIComponent(query);
        let query2Encoded = encodeURIComponent(query2);
        let newWindowUrl = `${location.pathname}?query=${queryEncoded}&query2=${query2Encoded}`;
        history.pushState({}, "", newWindowUrl);

        this.DoQueryEncode(query2);
        this.DoQueryDecode(query);
    }

    DoQueryEncode(query)
    {
        // process and output
        this.domResult2.innerHTML = "";

        let lineList = query.split("\n");
        for (let line of lineList)
        {
            let linePartList = line.trim().split(/\s+/);
            
            if (linePartList.length == 7)
            {
                let gridIn     = linePartList[0];
                let altM       = linePartList[1];
                let tempC      = linePartList[2];
                let voltage    = linePartList[3];
                let speedKnots = linePartList[4];
                let gpsValid   = linePartList[5];
                let gpsMin8Sat = linePartList[6];

                let grid5 = gridIn.substring(4, 5);
                let grid6 = gridIn.substring(5);

                let gridIn56 = grid5 + grid6;
                
                console.log(`${gridIn}, ${gridIn56}, ${altM}`);

                this.domResult2.innerHTML += `==========================\n`;
                this.domResult2.innerHTML += `[${gridIn}, ${gridIn56}, ${altM}, ${voltage}, ${speedKnots}, ${gpsValid}, ${gpsMin8Sat}]` + `\n`;
                this.domResult2.innerHTML += `==========================\n`;

                let call = WSPREncoded.EncodeU4BCall(gridIn56, altM);
                let [grid, power] = WSPREncoded.EncodeU4BGridPower(tempC, voltage, speedKnots, gpsValid, gpsMin8Sat);

                this.domResult2.innerHTML += `${call} ${grid} ${power}` + "\n\n";
            }
        }
    }

    DoQueryDecode(query)
    {
        // process and output
        this.domResult.innerHTML = "";

        let lineList = query.split("\n");
        for (let line of lineList)
        {
            let linePartList = line.trim().split(/\s+/);
            
            if (linePartList.length == 3)
            {
                let call  = linePartList[0];
                let grid  = linePartList[1];
                let power = linePartList[2];
                
                console.log(`${call}, ${grid}, ${power}`);

                this.domResult.innerHTML += `==========================\n`;
                this.domResult.innerHTML += `[${call}, ${grid}, ${power}]` + `\n`;
                this.domResult.innerHTML += `==========================\n`;
                let [grid56, altM] = WSPREncoded.DecodeU4BCall(call);
                let [tempC, voltage, speedKnots, gpsValid, gpsMin8Sat]=  WSPREncoded.DecodeU4BGridPower(grid, power);
                this.domResult.innerHTML += `....${grid56} ${altM} ${tempC} ${voltage} ${speedKnots} ${gpsValid} ${gpsMin8Sat}` + `\n\n`;
            }
        }
    }
}

window.addEventListener('DOMContentLoaded', (event) => {
    let app = new App();
});

</script>

<style>
* {
    font-family: Consolas,monaco,monospace;
    font-size: small;
}

section {
    display: inline-flex;
}

table, tr, th, td {
    border-collapse: collapse;
}

th {
    top: 0;
    position: sticky;
    border-top: 0px;
}

.headerRow {
    top: 0;
    position: sticky;
}

textarea {
    resize: both;
    height: 300px;
    min-width: 500px;
}

div {
    display: grid;
    border: 1px solid black;
    border-collapse: collapse;
    height: 300px;
    min-width: 600px;
    min-height: 300px;
    overflow-y: scroll;
    resize: both;
}

th, td {
    border: 1px solid lightgrey;
    border-collapse: collapse;
}

th {
    background-color: lightblue;
    border: 1px solid black;
}

td {
    text-align: center;
}

.err {
    background-color: lightcoral;
}


</style>

    </head>
    <body>
        encode: 6-char maidenhead, altitudeMeters, tempC, voltage, speedKnots, gpsValid(1 or 0), gpsSatMin8(1 or 0)
        <br/>
        <section>
            <textarea id="input2" spellcheck="false">
FN03IQ 1000 -12 4.2 0 1 1
FN03IQ 1000 -12 4.2 0 1 0
</textarea>
            <button id="query2">enc</button>
            <textarea id="result2" spellcheck="false"></textarea>
        </section>
        <br/>
        <br/>
        decode: call grid power
        <br/>
        <section>
            <textarea id="input" spellcheck="false">
0C0QRY HK52 23
0C0QRY HK52 20
</textarea>
            <button id="query">dec</button>
            <textarea id="result" spellcheck="false"></textarea>
        </section>
    </body>
</html>