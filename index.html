<html>
    <head>
        <title>Traquito</title>

<style>
    * {
        font-family: Consolas,monaco,monospace;;
    }
</style>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-07H1M3KB40"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-07H1M3KB40');
</script>

        <script type='module'>
import { WebSerial } from './js/WebSerial.js';


export class App
{
    constructor()
    {
        console.log("App Constructor");

        this.ws = new WebSerial();

        // Get DOM handles
        this.dom = {};
        this.dom.form = document.getElementById("form");
        this.dom.status = document.getElementById("status");
        this.dom.callsign = document.getElementById("callsign");
        this.dom.ping = document.getElementById("ping");
        this.dom.ping2 = document.getElementById("ping2");
        this.dom.input = document.getElementById("input");
        this.dom.reqstate = document.getElementById("reqstate");
        this.dom.output = document.getElementById("output");

        // Attempt to use local storage to set prior values
        this.dom.callsign.value = (localStorage.callsign == undefined ? "" : localStorage.callsign);

        // have the form just leave you alone and fill it out in peace
        this.dom.form.autocomplete = 'off';

        // Set up some styles
        this.OnDisconnected();

        // DOM interaction
        let sep = "";
        this.DomOutput = (str) => {
            this.dom.output.value += sep;
            sep = "\n";
            this.dom.output.value += str;
            this.dom.output.value += sep;
            this.dom.output.scrollTop = this.dom.output.scrollHeight;
        };

        // Change form behavior to simply give me a notice of hitting enter
        this.dom.form.onsubmit = (event) => {
            if (event) { event.preventDefault(); }

            // capture cacheable values
            localStorage.callsign = this.dom.callsign.value.trim();
            
            let input = this.dom.input.value.trim();
            this.dom.input.value = "";

            this.SendShellCmd(input);

            return false;
        };

        // Set up handlers
        this.dom.ping.onclick = (event) => {
            this.OnPingClick()
        };

        this.dom.ping2.onclick = (event) => {
            this.OnPing2Click()
        };

        this.ws.SetOnLineCallback((line) => {
            this.OnMessageLine(line);
        });

        this.ws.SetOnConnectedCallback(() => {
            this.OnConnected();
        });

        this.ws.SetOnDisconnectedCallback(() => {
            this.OnDisconnected();
        });

        ///////////////////////////////////////////////////
        // event handling
        ///////////////////////////////////////////////////

        this.OnPingClick = () => {
            this.pingTimeStart = performance.now();

            this.Send({
                "type" : "REQ_PING"
            });
        };

        this.OnPing2Click = () => {
            this.OnPingClick();

            this.Send({
                "type" : "REQ_PING2"
            });
        };

        ///////////////////////////////////////////////////
        // message handling
        ///////////////////////////////////////////////////

        this.Send = (jsonObj) => {
            let msgStr = JSON.stringify(jsonObj);

            this.DomOutput(`sending "${msgStr}"`);
            
            this.ws.Send(msgStr);
        };

        this.OnMessageLine = (line) => {
            try {
                let jsonObj = JSON.parse(line);

                let jsonStrPretty = JSON.stringify(jsonObj, null, 2);
                console.log(`Parsed json object from string of len ${line.length}`);
                console.log(jsonObj);

                this.DomOutput("received:" + "\n" + jsonStrPretty);

                this.OnMessage(jsonObj);
            } catch (e) {
                console.log(`Could not JSON.parse line "${line}`);
            }
        };

        this.OnMessage = (jsonObj) => {
            let type = jsonObj["type"];

            if (type == "REP_PING")
            {
                this.OnMessageRepPing(jsonObj);
            }
            if (type == "REP_PING2")
            {
                this.OnMessageRepPing2(jsonObj);
            }
            else if (type == "STATE")
            {
                this.OnMessageSTATE(jsonObj);
            }
        };

        this.OnMessageRepPing = (jsonObj) => {
            let rtt = performance.now() - this.pingTimeStart;
            let rttStr = rtt.toFixed(1);
            
            this.ping1Time = jsonObj["timeNow"];

            this.DomOutput(`Ping/Pong rtt ${rttStr} ms`);
        };
        this.OnMessageRepPing2 = (jsonObj) => {
            let ping2Time = jsonObj["timeNow"];
            let rttMcu = ping2Time - this.ping1Time;

            this.DomOutput(`Ping/Pong MCU saw back-to-back ${rttMcu} us`);
        };

        this.OnMessageSTATE = (jsonObj) => {
        };
    }

    async Connect()
    {
        this.ws.Connect();
    }
    
    async Disconnect()
    {
        this.ws.Disconnect();
    }

    async ReConnect()
    {
        this.ws.ReConnect();
    }

    OnConnected()
    {
        console.log("App Connected")

        this.dom.status.innerHTML = "Connected";
        this.dom.status.style.backgroundColor = "green";

        this.Send({
            "type": "REQ_STATE",
        });
    }

    OnDisconnected()
    {
        console.log("App Disconnected")

        this.dom.status.innerHTML = "Disconnected";
        this.dom.status.style.backgroundColor = "red";
    }

    SendType(str)
    {
        this.Send({
            "type" : str
        });
    }

    SendShellCmd(str)
    {
        this.Send({
            "type": "SHELL_COMMAND",
            "cmd": str,
        });
    }
}

export let app = null;

window.addEventListener('DOMContentLoaded', (event) => {
    app = new App();
    window.app = app;
});

</script>
<script>
function Commas(num)
{
    let ret = num;
    try {
        ret = parseInt(num).toLocaleString("en-US");
    } catch (e) {
        // nothing
    }

    return ret;
}
</script>
<style>

</style>
    </head>
    <body>
        <div id="status">Status</div>

        <br/>

        <button onclick="app.Connect()">Connect</button>
        <button onclick="app.Disconnect()">Disconnect</button>
        <button onclick="app.ReConnect()">Re-Connect</button>
        <button onclick="app.SendType('REQ_STATE')">ReqState</button>
        <button id="ping">ReqPing</button>
        <button id="ping2">ReqPing2</button>
        <button onclick="app.SendShellCmd('sys.time')">sys.time</button>
        
        <br/>
        <section>

        <fieldset>
        <legend>Subsystem</legend>
        <section>
        app.gps on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.gps on` : `app.gps off`)" >
        <br/>
        app.tx on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.tx on` : `app.tx off`)" >
        </section>
    
        <section>
        LED green on/off <input type='checkbox' oninput="app.SendShellCmd(`app.test.led.green ` + (this.checked ? `on` : `off`))" >
        <br/>
        LED red on/off <input type='checkbox' oninput="app.SendShellCmd(`app.test.led.red ` + (this.checked ? `on` : `off`))" >
        </section>
        </fieldset>

        
        <fieldset>
            <legend>Frequency Calibration</legend>

        
        app.wc.start/stop <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.wc.start` : `app.wc.stop`)" >
        <br/>
        app.si.on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.si.on` : `app.si.off`)" >
        <br/>
        app.si.freq RF
        <input
            type='range'
            style="width: 25%;"
            min='14095000' max='14100000' step='100'
            value="14097000"
            oninput="freq.innerHTML = Commas(this.value);
                     app.SendShellCmd(`app.si.freq ${this.value / 1000000}`)"
            onload="console.log(`I loaded`)"
            onchange="freq.value = this.value"
        >
        <br/>
        app.si.freq calibration
        <input
            type='range'
            style="width: 25%;"
            min='1900000' max='2000000' step='100'
            oninput="freq.innerHTML = Commas(this.value);
                     app.SendShellCmd(`app.si.freq ${this.value / 1000000}`)"
            onload="console.log(`I loaded`)"
            onchange="freq.value = this.value"
        >
        <span id="freq"></span>
        <br/>
        app.si.corr <input id="app_si_corr" type='range' min='0' step='1000' max='20000' style="width: 25%;" oninput="app.SendShellCmd(`app.si.corr ${this.value}`)" >
        <br/>

        </fieldset>
        </section>


        <br/>
        <section>
        <fieldset>
        <legend>Debug</legend>

            
        <form id="form">
            <input type="submit" style="display:none;">
            <div style="display: none;">
                callsign <input id="callsign" type="text" length="6" spellcheck="false">
            </div>
            <br/>
            shell <input id="input" type="text" length="15" spellcheck="false">
        </form>
        
        <textarea id="output" rows="20" cols="80" readonly></textarea>

        </fieldset>    
        </section>
            
    </body>
</html>