<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Spot Map - Traquito</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>

    <script type='module'>



import { WSPREncoded } from '/js/WSPREncoded.js';
import { TabularData } from '/js/TabularData.js';
import { Spot, SpotMap } from './SpotMap.js';

let map = null;
window.addEventListener('DOMContentLoaded', (event) => {
    window.top.postMessage({
        type: "REQ_DATA",
    }, "*");
});


window.addEventListener("message", e => {
    SendSpotsToMap(e.data.dataTable);
});

function SendSpotsToMap(dataTable)
{
    // avoid jank of map loading, then later getting the data we know it will center on
    map = new SpotMap({
        idMap: "map",
    });

    let td = new TabularData(dataTable);

    let spotList = [];

    td.ForEach((row) => {
        let grid = td.Get(row, "Grid");

        if (grid)
        {
            let [lat, lng] = WSPREncoded.DecodeMaidenheadToDeg(grid);
    
            let spot = new Spot({
                lat: lat,
                lng: lng,
            });

            spotList.push(spot);
        }
    });

    if (spotList.length)
    {
        map.AddSpotList(spotList);
    }
}







    </script>

<style>
body {
    margin: 0;
}
.map {
    margin: 0;
    position: absolute;
    width: 100%;
    height: 100%;
}
</style>

  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="popup" class="no-ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
  </body>
</html>
