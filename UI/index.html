<html>
    <head>
        <title>Traquito</title>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-07H1M3KB40"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-07H1M3KB40');
</script>

<!-- https://github.com/apvarun/toastify-js/blob/master/README.md -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

        <script type='module'>
import * as autl from './AppUtl.js';
import { Connection } from './Connection.js';
import { DebugController } from './DebugController.js';
import { ConnectController } from './ConnectController.js';
import { DeviceInfoController } from './DeviceInfoController.js';
import { ConfigWsprController } from './ConfigWsprController.js';


/////////////////////////////////////////////////////////////////////
// App
/////////////////////////////////////////////////////////////////////

export class App
{
    constructor()
    {
        console.log("App Started");

        // create
        this.conn = new Connection();

        this.debugController       = new DebugController();
        this.connectController     = new ConnectController();
        this.deviceInfoController  = new DeviceInfoController();
        this.configWsprController  = new ConfigWsprController();

        // capture
        this.controllerList = [];
        this.controllerList.push(this.debugController);
        this.controllerList.push(this.connectController);
        this.controllerList.push(this.deviceInfoController);
        this.controllerList.push(this.configWsprController);

        // configure
        this.conn.Configure({
            dbg: this.debugController,
            evtHandler: this,
            filterList: [
                {
                    usbVendorId: 12259,
                    usbProductId: 8,
                },
            ],
        });
        
        this.debugController.Configure({
            dbg: this.debugController,
            conn: this.conn,
            idForm: "form",
            idInput: "input",
            idOutput: "output",
            idPing: "ping",
            idPing2: "ping2",
        });

        this.connectController.Configure({
            dbg: this.debugController,
            conn: this.conn,
            idStatus: "status",
            idConnect: "connect",
            idDisconnect: "disconnect",
        });

        this.deviceInfoController.Configure({
            dbg: this.debugController,
            conn: this.conn,
            idDeviceInfo: "deviceInfo",
        });

        this.configWsprController.Configure({
            dbg: this.debugController,
            conn: this.conn,
            idBand: "band",
            idChannel: "channel",
            idCallsign: "callsign",
            idSaveButton: "saveConfig",
        });
        

        // set up message type to handler mappings
        this.msgType__handler = new Map();

        for (const controller of this.controllerList)
        {
            if (controller.GetMessageTypeMapList)
            {
                for (const msgTypeMap of controller.GetMessageTypeMapList())
                {
                    let msgType = msgTypeMap.msgType;
                    let cbFn    = msgTypeMap.cbFn;
    
                    if (this.msgType__handler.has(msgType) == false)
                    {
                        this.msgType__handler.set(msgType, cbFn);
                    }
                    else
                    {
                        this.debugController.Debug(`ERR: ${msgType} registered more than once`);
                    }
                }
            }
        }
    }

// private


    OnConnected()
    {
        autl.ToastOk("Connected");
        
        for (const controller of this.controllerList)
        {
            if (controller.OnConnected)
            {
                controller.OnConnected();
            }
        }
    }
    
    OnDisconnected(ok)
    {
        if (ok)
        {
            autl.ToastOk("Disconnected (expected)");
        }
        else
        {
            autl.ToastErr("Disconnected (unexpected)");
        }

        for (const controller of this.controllerList)
        {
            if (controller.OnDisconnected)
            {
                controller.OnDisconnected();
            }
        }
    }

    OnMessage(msg)
    {
        let msgType = msg["type"];

        if (this.msgType__handler.has(msgType))
        {
            let cbFn = this.msgType__handler.get(msgType);

            try {
                cbFn(msg);
            } catch (e) {
                let err = `Error handling type "${msgType}": ${e}`;

                console.log(err);
                console.log(msg);
                console.log(e);

                this.debugController.Debug(err);

                this.connectController.SetErrorStyle();
            }
        }
        else
        {
            let err = `No handler for type "${msgType}"`;

            console.log(err);
            console.log(msg);

            this.debugController.Debug(err);

            this.connectController.SetErrorStyle();
        }
    };
}

export let app = null;

window.addEventListener('DOMContentLoaded', (event) => {
    app = new App();
    window.app = app;
});

</script>
<script>
function Commas(num)
{
    let ret = num;
    try {
        ret = parseInt(num).toLocaleString("en-US");
    } catch (e) {
        // nothing
    }

    return ret;
}
</script>



<style>
* {
    font-family: Consolas,monaco,monospace;;
}

#status {
    padding: 2px;
    display: inline-block;
    min-width: 150px;
}

#deviceInfo {
    display: inline-block;
}
</style>



    </head>
    <body>

        <fieldset>
            <legend>Tracker Connection</legend>
            <section>
                <button id="connect">Connect</button>
                <button id="disconnect">Disconnect</button>
                Status <span id="status">Disconnected</span>
                <span id="deviceInfo"></span>
            </section>
        </fieldset>    


        <section>
            <fieldset>
                <legend>WSPR Configuration</legend>
        


        <select id="band" title="band" value="20m">
            <option value="2190m">2190m (LF)</option>
            <option value="630m">630m (MF)</option>
            <option value="160m">160m</option>
            <option value="80m">80m</option>
            <option value="60m">60m</option>
            <option value="40m">40m</option>
            <option value="30m">30m</option>
            <option value="20m" selected>20m</option>
            <option value="17m">17m</option>
            <option value="15m">15m</option>
            <option value="12m">12m</option>
            <option value="10m">10m</option>
            <option value="6m">6m</option>
            <option value="4m">4m</option>
            <option value="2m">2m</option>
            <option value="70cm">70cm</option>
            <option value="23cm">23cm</option>
        </select>

        <input id="channel" type="number" value="0" min="0" max="599" title="channel" placeholder="channel">

        <input id="callsign" title="callsign" placeholder="callsign" size="7"></input>

        <button id="saveConfig">Save</button>

            </fieldset>


    </section>
















        <section>

        <fieldset>
        <legend>Subsystem</legend>
        <section>
        app.gps on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.gps on` : `app.gps off`)" >
        <br/>
        app.tx on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.tx on` : `app.tx off`)" >
        </section>
    
        <section>
        LED green on/off <input type='checkbox' oninput="app.SendShellCmd(`app.test.led.green ` + (this.checked ? `on` : `off`))" >
        <br/>
        LED red on/off <input type='checkbox' oninput="app.SendShellCmd(`app.test.led.red ` + (this.checked ? `on` : `off`))" >
        </section>
        </fieldset>

        
        <fieldset>
            <legend>Frequency Calibration</legend>

        
        app.wc.start/stop <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.wc.start` : `app.wc.stop`)" >
        <br/>
        app.si.on/off <input type='checkbox' oninput="app.SendShellCmd(this.checked ? `app.si.on` : `app.si.off`)" >
        <br/>
        app.si.freq RF
        <input
            type='range'
            style="width: 25%;"
            min='14095000' max='14100000' step='100'
            value="14097000"
            oninput="freq.innerHTML = Commas(this.value);
                     app.SendShellCmd(`app.si.freq ${this.value / 1000000}`)"
            onload="console.log(`I loaded`)"
            onchange="freq.value = this.value"
        >
        <br/>
        app.si.freq calibration
        <input
            type='range'
            style="width: 25%;"
            min='1900000' max='2000000' step='100'
            oninput="freq.innerHTML = Commas(this.value);
                     app.SendShellCmd(`app.si.freq ${this.value / 1000000}`)"
            onload="console.log(`I loaded`)"
            onchange="freq.value = this.value"
        >
        <span id="freq"></span>
        <br/>
        app.si.corr <input id="app_si_corr" type='range' min='0' step='1000' max='20000' style="width: 25%;" oninput="app.SendShellCmd(`app.si.corr ${this.value}`)" >
        <br/>

        </fieldset>
        </section>


        <br/>
        <section>
        <fieldset>
        <legend>Debug</legend>

            
        <form id="form">
            <input type="submit" style="display:none;">
            shell <input id="input" type="text" length="15" spellcheck="false">
            <button id="ping">ReqPing</button>
            <button id="ping2">ReqPing2</button>
        </form>
        

        <textarea id="output" rows="20" cols="80" readonly></textarea>

        </fieldset>    
        </section>
            
    </body>
</html>